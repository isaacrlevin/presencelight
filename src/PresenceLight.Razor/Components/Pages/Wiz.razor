@page "/wiz"


@inject ILogger<Wiz> _logger;

<MudPaper Width="100%" Elevation="0">
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Style="text-align:center">
        <MudText Typo="Typo.h3">Configure Wiz</MudText>
        <MudGrid Class="mt-5" Justify="Justify.Center">
            <MudItem xs="12">
                <MudCheckBox @bind-Value="@appState.Config.LightSettings.Wiz.IsEnabled" Label="Connect to Wiz"></MudCheckBox>
            </MudItem>
        </MudGrid>
        @if (appState.Config.LightSettings.Wiz.IsEnabled)
        {
            <MudGrid Justify="Justify.Center">
                <MudItem xs="4">
                    <EditForm Model="@appState.Config" OnValidSubmit="GetLight">
                        <DataAnnotationsValidator />
                        <MudTextField Label="IP Address"
                                      Variant="Variant.Outlined"
                                      @bind-Value="@appState.Config.LightSettings.Wiz.IPAddress"
                                      For="@(() => appState.Config.LightSettings.Wiz.IPAddress)"
                                      Validation="true" />
                        <br />

                        <MudButton ButtonType="MudBlazor.ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="MudBlazor.Color.Primary">Get Light</MudButton>
                    </EditForm>
                </MudItem>
            </MudGrid>

            @if (showWizMessage)
            {
                <MudGrid Class="mt-5" Justify="Justify.Center">
                    <MudItem xs="12">
                        <MudText Class=@wizMessageClass Typo="Typo.body1">@wizMessage</MudText>
                    </MudItem>
                </MudGrid>
            }
            if (isLoadingLights)
            {
                <br />

                <br />
                <Circle Center="true" />
            }
            else
            {
                @if (appState.WizLight != null)
                {
                    <MudGrid Class="mt-5 align-center" Justify="Justify.FlexStart">
                        <MudItem xs="3">
                            <MudText Typo="Typo.h5">Brightness</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSlider @bind-Value="appState.Config.LightSettings.Wiz.Brightness" Min="0" Max="100"></MudSlider>
                        </MudItem>
                        <MudItem xs="2">
                            <MudNumericField @bind-Value="appState.Config.LightSettings.Wiz.Brightness" Variant="Variant.Outlined" Min="0" Max="100" Step="1" />
                        </MudItem>
                    </MudGrid>

                    <Statuses Light="@appState.Config.LightSettings.Wiz"></Statuses>
                }
            }
        }
        <MudItem Class="mt-5" xs="12">
            <MudButton Class="mb-10" OnClick="Save" Variant="Variant.Filled" Color="MudBlazor.Color.Primary">Save</MudButton>
            @if (settingsSaved)
            {
                <MudText Color="MudBlazor.Color.Success">@message</MudText>
            }
        </MudItem>
    </MudContainer>
</MudPaper>

@code {

    bool settingsSaved = false;
    bool isLoadingLights = false;
    string message;
    string wizMessageClass;

    bool showWizMessage = false;
    string wizMessage;
    string selectedLightLabel = "";
    string ipAddress = "";
    protected override async Task OnInitializedAsync()
    {
        try
        {
            appState.OnChange += RaiseStateHasChanged;

            if (!appState.SignedIn)
            {
                NavManager.NavigateTo("/");
            }

            await GetLight();
        }

        catch (Exception e)
        {
            _logger.LogError(e, "Error Occurred loading Wiz");
            throw;
        }
        await Task.CompletedTask;
    }

    private async Task Save()
    {
        try
        {
            await SettingsService.SaveSettings(appState.Config);
            message = "Settings Saved";
            settingsSaved = true;
            _logger.LogInformation("Settings Saved from Wiz Page");
        }
        catch (Exception e)
        {
            _logger.LogError(e, "Error Occurred Saving Wiz Settings");
            throw;
        }
    }

    public async Task GetLight()
    {
        if (appState.Config.LightSettings.Wiz.IsEnabled && !string.IsNullOrEmpty(appState.Config.LightSettings.Wiz.IPAddress))
        {
            if (System.Text.RegularExpressions.Regex.IsMatch(
                 appState.Config.LightSettings.Wiz.IPAddress,
                 @"\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b"))
            {

                try
                {
                    isLoadingLights = true;
                    _logger.LogInformation("Wiz Light Retrieval Initialized");
                    appState.SetWizLight(await _mediator.Send(new Core.WizServices.GetLightCommand()));

                    if (string.IsNullOrEmpty(appState.Config.LightSettings.Wiz.SelectedItemId) && appState.WizLight != null)
                    {
                        appState.Config.LightSettings.Wiz.SelectedItemId = appState.WizLight.MacAddress;
                    }
                    else
                    {
                        selectedLightLabel = appState.WizLight.LightName;
                    }
                    _logger.LogInformation("Wiz Light Retrieval Successful");
                    showWizMessage = true;
                    wizMessage = $"Connected to {appState.WizLight.LightName}";
                    wizMessageClass = "text-success";
                    isLoadingLights = false;
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error occurred Finding Wiz Lights");
                    wizMessage = "Error Occurred finding light, please try another IP Address";
                    showWizMessage = true;
                    wizMessageClass = "text-danger";
                    throw;
                }
            }
            else
            {
                wizMessage = "Not a valid IP Address";
                showWizMessage = true;
                wizMessageClass = "text-danger";
            }
        }
    }

    public void Dispose()
    {
        appState.OnChange -= RaiseStateHasChanged;
    }

    private void RaiseStateHasChanged()
    {
        InvokeAsync(StateHasChanged);
    }
}
